#!/bin/bash
set -e

echo "🟡 Limpiando carpeta de trabajo..."
rm -rf /opt/app-root/src/*

echo "🟡 Copiando código fuente desde /tmp/src..."
cp -R /tmp/src/. /opt/app-root/src/

echo "🟡 Eliminando archivos ocultos innecesarios..."
rm -rf /opt/app-root/src/.git*

echo "🟡 Instalando dependencias (si existe requirements.txt)..."
if [ -f /opt/app-root/src/requirements.txt ]; then
    pip install --no-cache-dir -r /opt/app-root/src/requirements.txt
else
    echo "⚠️ No se encontró requirements.txt"
fi

echo "🟡 Ajustando permisos..."
chown -R 1001:0 /opt/app-root/src
chmod -R g+w /opt/app-root/src

echo "✅ Código copiado. Mostrando estructura del directorio:"
echo "---------------------------------------------"
find /opt/app-root/src -type f
echo "---------------------------------------------"
